var currencyData={currencyFormat:currencyFormat,currencySign:currencySign,currencyBlank:currencyBlank}
function createElement(elementTag,elementType,elementClass,elementId,elementName,elementValue){var newElement=$(document.createElement(elementTag));if(elementType!==false)newElement.attr('type',elementType);if(elementClass!==false)newElement.addClass(elementClass);if(elementId!==false)newElement.attr('id',elementId);if(elementName!==false)newElement.attr('name',elementName);if(elementValue!==false){if(elementTag=='input')newElement.val(elementValue);else newElement.html(elementValue)}
return newElement}
function newDomElement(options){if(typeof(options.elementTag)=='undefined')return false;var newElement=$(document.createElement(options.elementTag));if(typeof(options.attrs)!='undefined'){for(var attributeName in options.attrs){var attributeValue=options.attrs[attributeName];newElement.attr(attributeName,attributeValue);}}
if(typeof(options.elementValue)!='undefined'){if(options.elementTag=='input')newElement.val(options.elementValue);else
newElement.html(options.elementValue);}
return newElement}
function slideUpAndDestroy(jqObj){if(typeof(jqObj)!='undefined'){jqObj.fadeOut('fast');jqObj.slideUp('fast',function(){$(this).remove()})}}
function createMessage(msgClass,message,icon){if(icon=='undefined')return newDomElement({elementTag:'div',attrs:{'class':msgClass},elementValue:message});else{var messageBlock=newDomElement({elementTag:'div',attrs:{'class':msgClass},elementValue:' '+message});messageBlock=$(messageBlock).prepend($(document.createElement('img')).attr('src','../img/admin/'+icon));return messageBlock}}
function createConfirmation(message,icon,prependTo,fadeAfter){prependTo=prependTo||'div#orderEditorContainer';var messageBlock=(createMessage('conf confirm',message,icon)).prependTo($(prependTo));if(fadeAfter)setTimeout(function(){slideUpAndDestroy(messageBlock)},parseInt(fadeAfter))}
function createError(message,icon,prependTo){prependTo=prependTo||'div#orderEditorContainer';$(prependTo).prepend(createMessage('alert error',message,icon))}
function sendRequest(params,callback,format){format=format||'html';if(typeof(params)=='object'){params.id_lang=id_lang;params.iem=iem;params.iemp=iemp}
$.post(ajaxPath,params,function(data){callback.apply(data,arguments)},format)}
function requestProductInfo(event,data,formatted){var productId=parseInt(data[1]),productName=data[0],container=$('div#productToAdd');container.slideUp('fast');sendRequest({getfull:productId},function(data){if(data.length>0){container.html(data).slideDown('fast')}})}
function requestCustomerInfo(event,data,formatted){var customerId=parseInt(data[1]),container=$('div#customer');container.slideUp('fast');sendRequest({getcustomer:customerId},function(data){if(data.length>0){container.html(data);$('div#customer div.addressItem:odd').css('margin-right',0);container.slideDown('fast')}})}
function reformatPrices(){$('span.customValue, span.publicView').each(function(){var parent=$(this).parent('.editable');if(parent.length>0&&parent.attr('class').split(' ').length==1&&$(this).html()!=''){var realValue=parent.find('span.realValue > input','span.realValue > textarea').val();formatPrice($(this),realValue);}});}
function formatPrice(obj,price){if(isNaN(price))price=0;var newPrice=formatCurrency(price,currencyData.currencyFormat,currencyData.currencySign,currencyData.currencyBlank);obj.html(newPrice)}
function ps_round(value,precision){if(typeof(roundMode)=='undefined')roundMode=2;if(typeof(precision)=='undefined')precision=2;method=roundMode;if(method==0)return ceilf(value,precision);else if(method==1)return floorf(value,precision);precisionFactor=precision==0?1:Math.pow(10,precision);return Math.round(value*precisionFactor)/precisionFactor}
function ceilf(value,precision){if(typeof(precision)=='undefined')precision=0;precisionFactor=precision==0?1:Math.pow(10,precision);tmp=value*precisionFactor;tmp2=tmp.toString();if(tmp2[tmp2.length-1]==0)return value;return Math.ceil(value*precisionFactor)/precisionFactor}
function floorf(value,precision){if(typeof(precision)=='undefined')precision=0;precisionFactor=precision==0?1:Math.pow(10,precision);tmp=value*precisionFactor;tmp2=tmp.toString();if(tmp2[tmp2.length-1]==0)return value;return Math.floor(value*precisionFactor)/precisionFactor}
function formatCurrency(price,currencyFormat,currencySign,currencyBlank){blank='';price=parseFloat(price).toFixed(6);price=ps_round(price,2);if(currencyBlank>0)blank=' ';if(currencyFormat==1)return currencySign+blank+formatNumber(price,2,',','.');if(currencyFormat==2)return(formatNumber(price,2,' ',',')+blank+currencySign);if(currencyFormat==3)return(currencySign+blank+formatNumber(price,2,'.',','));if(currencyFormat==4)return(formatNumber(price,2,',','.')+blank+currencySign);return price}
function formatNumber(value,numberOfDecimal,thousenSeparator,virgule){value=value.toFixed(numberOfDecimal);var val_string=value+'';var tmp=val_string.split('.');var abs_val_string=(tmp.length==2)?tmp[0]:val_string;var deci_string=('0.'+(tmp.length==2?tmp[1]:0)).substr(2);var nb=abs_val_string.length;for(var i=1;i<4;i++)if(value>=Math.pow(10,(3*i)))abs_val_string=abs_val_string.substring(0,nb-(3*i))+thousenSeparator+abs_val_string.substring(nb-(3*i));if(parseInt(numberOfDecimal)==0)return abs_val_string;return abs_val_string+virgule+(deci_string>0?deci_string:'00')}
function recalculateTotal(){var collection=$('table#orderContents').children('tbody').children('tr'),shipping=parseFloat($('input#total_shipping').val()),discounts=parseFloat($('input#total_discount').val()),discountType=parseInt($('input[name="discountType"]:checked').val()),wrapping=parseFloat($('input#total_wrapping').val()),total_products=0;order_total=0;if(collection.length){collection.each(function(){var price=parseFloat($(this).find('input.orderPPrice').val());var price_wt=parseFloat($(this).find('input.orderPPriceWt').val());var quantity=parseInt($(this).find('input.orderPQuantity').val());formatPrice($(this).find('.productsTotalPrice'),price_wt*quantity);total_products+=(price_wt*quantity)})}
order_total=parseFloat(total_products+shipping+wrapping);discounts=discountType==0?(order_total*(discounts/100)):discounts;order_total-=discounts;$('#orderTotalProductsF').val(total_products);$('#orderShippingPriceF').val(shipping);$('#orderTotalPriceF').val(order_total);if(discountType==0){$('#orderDiscounts').find('input#total_discount').val(discounts.toFixed(2));formatPrice($('#orderDiscounts').find('span.customValue'),discounts.toFixed(2));$('input#discountType_val').attr('checked',true);}
formatPrice($('#orderTotalProducts').find('span.customValue'),total_products);formatPrice($('#orderTotalPrice').find('span.customValue'),order_total);formatPrice($('#orderTotalDiscounts').find('span.customValue'),discounts);formatPrice($('#orderWrappingPrice').find('span.customValue'),wrapping);formatPrice($('#orderShippingPrice').find('span.customValue'),shipping)}
function getProductDetails(productId){var product_details={};var collection=$('input[name^="product['+productId+']"]');if(collection.length){collection.each(function(){var option=$(this);var type=option.attr('name').match(/product\[\d+\]\[(\w+)\]/);product_details[type[1]]=option.val()})}
return product_details}
function calcPrice(index,p_id,withTax){var tax=parseFloat($('input[name="product['+index+']['+p_id+'][tax_rate]"]').val());var price=parseFloat($('input[name="product['+index+']['+p_id+'][price]"]').val());var taxprice=parseFloat($('input[name="product['+index+']['+p_id+'][price_wt]"]').val());var priceEmpty=true;if(!withTax){var newprice=price*(1+tax*0.01);priceEmpty=(isNaN(newprice)||newprice<0);changeValue(index,p_id,'price',priceEmpty?0:price,true);changeValue(index,p_id,'price_wt',priceEmpty?0:newprice.toFixed(4),true)}else if(withTax){var newprice=taxprice/(1+tax*0.01);priceEmpty=(isNaN(newprice)==true||newprice<0);changeValue(index,p_id,'price',priceEmpty?0:newprice.toFixed(4),true);changeValue(index,p_id,'price_wt',priceEmpty?0:taxprice,true)}}
function changeValue(index,productId,key,newValue,format){var obj=$('input[name="product['+index+']['+productId+']['+key+']"]');obj.val(newValue);if(format){formatPrice(obj.parents('.editable').find('span.customValue'),newValue)}else obj.parents('.editable').find('span.customValue').html(newValue);recalculateTotal()}
function getValCast(selector,cast){cast=cast||parseFloat;return cast.apply(null,[$(selector).val()])}
function getOrderFormRequestStr(){var form=$('form#orderForm');var formData=form.serialize(),shipping=getValCast('input#total_shipping'),discounts=getValCast('input#total_discount'),wrapping=getValCast('input#total_wrapping'),payment=getValCast('select#paymentModule',parseInt),totalP=getValCast('input#orderTotalProductsF'),total=getValCast('input#orderTotalPriceF'),carrier=getValCast('select#carrierNew',parseInt),orderId=getValCast('input#OrderId',parseInt),orderStatus=getValCast('select#orderStatus',parseInt),currency=getValCast('select#orderCurrency',parseInt);var requestStrObj={carrier:carrier,total_shipping:shipping,discounts:discounts,wrapping:wrapping,totalproducts:totalP,total:total,payment:payment,currency:currency,status:orderStatus};if(isNaN(orderId)){var addressDelivery=getValCast('#addressdelivery input.id_address',parseInt),addressInvoice=getValCast('#addressinvoice input.id_address',parseInt),customer=getValCast('#addressinvoice input.id_customer',parseInt);if(!isNaN(addressDelivery))requestStrObj.delivery=addressDelivery;if(!isNaN(addressInvoice))requestStrObj.invoice=addressInvoice;if(!isNaN(customer))requestStrObj.customer=customer}
var requestStr=createPathString(requestStrObj);formData+=requestStr;return formData;}
function updateOrder(){$('div.conf').slideUp('fast',function(){$(this).remove()});$('div.error').slideUp('fast',function(){$(this).remove()});var formData=getOrderFormRequestStr()+'&order_update=1';$.post(ajaxPath,formData,function(data){if(data.order){$('form#orderForm').append(newDomElement({elementTag:'input',attrs:{'type':'hidden','id':'orderId','name':'orderId'},elementValue:data.order}));if(data.details){var productRow;var renderedProducts=$('table#orderContents').find('tbody').children('tr');for(var index in data.details){var detail=data.details[index];productRow=$('input.indexProduct[value="'+index+'"]');if(productRow.length){$('form#orderForm').append(newDomElement({elementTag:'input',attrs:{'type':'hidden','class':'orderDetailId','name':'product['+index+']['+detail.product+'][order_detail]'},elementValue:detail.order_detail}));}}
$('fieldset#customerSelector').slideUp('fast',function(){$(this).remove()})}
$('div#productToAdd').slideUp('fast',function(){$(this).empty()});createConfirmation(data.message,'enabled.gif','fieldset#orderedProductsWrapper',500)}else if(data.errors){for(var i in data.errors){var error=data.errors[i];createError(error,'warning.gif','fieldset#orderedProductsWrapper')}}
var collection=$('span.customValue').not('.orderDetails');if(collection.length){collection.each(function(){if($(this).html().length){$(this).next('span.publicView').html($(this).html());$(this).html('')}})}},'json')}
function createPathString(obj){var path='';if(typeof(obj)=='object'){obj.id_lang=id_lang;obj.iem=iem;obj.iemp=iemp;for(var key in obj){var value=obj[key];if(value!="undefined")path+='&'+key+'='+value}
return path}
return}
var delay=(function(){var timer=0;return function(callback,ms){clearTimeout(timer);timer=setTimeout(callback,ms);};})();$(document).ready(function(){$('select#orderCurrency').change(function(){sendRequest({getCurrency:$(this).val()},function(data){if(data&&typeof(data)=='object'){currencyData=data;reformatPrices();recalculateTotal();}},'json');});$('span.realValue > input').live('blur',function(evt){$(this).parent('span.realValue').fadeOut('fast',function(){var parent=$(this).parent('.editable');parent.find('span.publicView').fadeIn('fast')})});$('span.realValue > input, span.realValue > textarea').live('keyup',function(evt){var thisObj=$(this);delay(function(){thisObj.val(thisObj.val().replace(/,/g,'.'));if(thisObj.hasClass('cpOnKeyUp')){var withTax=false;var info=thisObj.attr('name').match(/product\[(\d+)\]\[(\d+)\]\[(\w+)\]/);var index=parseInt(info[1]);var productId=parseInt(info[2]);if(info[3]=='price_wt')withTax=true;calcPrice(index,productId,withTax)}else{if(thisObj.hasClass('priceFormat')){formatPrice(thisObj.parents('.editable').find('span.customValue'),thisObj.val())}else if(thisObj.hasClass('weightFormat')){thisObj.parents('.editable').find('span.customValue').html(thisObj.val()+weightUnit)}else if(thisObj.hasClass('percentageFormat')){thisObj.parents('.editable').find('span.customValue').html(thisObj.val()+'%')}else if(thisObj.hasClass('productName'))thisObj.parents('.editable').find('span.customValue').html(thisObj.val().replace('\n','<br />\n'));else
thisObj.parents('.editable').find('span.customValue').html(thisObj.val());recalculateTotal()}},1000);});$('span.publicView').live('click',function(evt){$('span.realValue:visible').fadeOut('fast',function(){$(this).prev('span.publicView').fadeIn('fast')});var editable=$(this).parent('.editable');var input=editable.find('span.realValue');var view=editable.find('span.publicView');if(input.length&&view.length)view.fadeOut('fast',function(){input.fadeIn('fast');input.find('input[type="text"]').focus()})});$('span.addProduct').live('click',function(evt){var orderId=getValCast('input#orderId',parseInt);var attr=$(this).attr('id').split('_');var info=$('table#orderContents').children('tbody').find('tr:last').find('td:first').find('input[type="hidden"]');var index=0;var orderCurrency=$('select#orderCurrency').val();if(info.length){info=info.attr('name').match(/product\[(\d+)\]\[\d+\]\[\w+\]/);index=parseInt(info[1])+1}
switch(attr[0]){case'combo':var productArgs={addProduct:parseInt(attr[1]),index:index,oid:orderId,currency:orderCurrency,id_combination:parseInt(attr[2])};break;case'product':var productArgs={addProduct:parseInt(attr[1]),index:index,oid:orderId,currency:orderCurrency,id_combination:0};break}
sendRequest(productArgs,function(data){$('table#orderContents').children('tbody').fadeTo(600,0,function(){$(this).append(data);recalculateTotal();$(this).fadeTo(600,1)})})});$('span.deleteProduct').live('click',function(evt){$(this).parents('tr').fadeOut('fast',function(){$(this).remove();recalculateTotal();})});$('span.addAddress').live('click',function(evt){var address=$(this).parents('div.addressItem').find('div.address'),deliverySelector='#addressdelivery',invoiceSelector='#addressinvoice',deliveryContainer=$(deliverySelector).find('div.addressContainer'),invoiceContainer=$(invoiceSelector).find('div.addressContainer'),target=$(this).hasClass('shipping')?deliveryContainer:invoiceContainer;$(target).fadeOut('fast',function(){$(this).empty();$(this).prepend(address.clone());$(this).fadeIn('fast');var deliveryHasAddress=$(deliverySelector).find('div.addressContainer').find('div.address');var invoiceHasAddress=$(invoiceSelector).find('div.addressContainer').find('div.address');if(deliveryHasAddress.length&&invoiceHasAddress.length){$('div#customer').slideUp('fast',function(){$(this).empty()})}})});$('input#autoCalculate').click(function(){$('fieldset#orderCarriers').find('div.conf').slideUp('fast',function(){$(this).remove()});$('fieldset#orderCarriers').find('div.error').slideUp('fast',function(){$(this).remove()});var formData=getOrderFormRequestStr()+'&calculateShipping=1';$.post(ajaxPath,formData,function(data){if(data.shipping_price){var shippingContainer=$('#shippingPriceContainer').find('.editable');formatPrice(shippingContainer.find('span.customValue'),data.shipping_price);$('input#total_shipping').val(parseFloat(data.shipping_price));recalculateTotal();createConfirmation(data.message,'enabled.gif','fieldset#orderCarriers',500)}else if(data.errors){for(var i in data.errors){var error=data.errors[i];createError(error,'warning.gif','fieldset#orderCarriers')}}},'json')});$('a#customerCreate').click(function(evt){evt.preventDefault();slideUpAndDestroy($('form#newCustomerWrapper'));sendRequest({customerCreate:true},function(data){$('a#customerCreate').slideUp('fast',function(){$(data).insertAfter($(this)).slideDown();});});return false;});$('form#newCustomerWrapper').live('submit',function(evt){evt.preventDefault();var data={},addressData={},groups=[];$('form#newCustomerWrapper').find('div.conf').slideUp('fast',function(){$(this).remove()});$('form#newCustomerWrapper').find('div.error').slideUp('fast',function(){$(this).remove()});$(this).find('input[name^=addressNw], select[name^=addressNw], textarea[name^=addressNw]').each(function(){var parsed=$(this).attr('name').match(/addressNw\[(\d+)\]\[(\w+)\]/);var tmp=parsed[2];if(typeof(addressData[parsed[1]])=='undefined')addressData[parsed[1]]={};addressData[parsed[1]][parsed[2]]=$(this).val();});$(this).find('input.groupBox:checked').each(function(){groups.push($(this).val());});$(this).find('input.customerNw, select.customerNw').each(function(){data[$(this).attr('name')]=$(this).val();});$.post(ajaxPath,{id_lang:id_lang,iem:iem,iemp:iemp,customerCreateSave:true,customer:data,groups:groups,addresses:addressData},function(data){if(data.success){createConfirmation(data.message,'enabled.gif','form#newCustomerWrapper',500);setTimeout(function(){slideUpAndDestroy($('form#newCustomerWrapper'));$('a#customerCreate').slideDown('fast');requestCustomerInfo(false,[0,data.customerID]);},500)}else if(data.errors){for(var i in data.errors){var error=data.errors[i];createError(error,'warning.gif','form#newCustomerWrapper')}}},'json');return false;});$('a.duplicator').live('click',function(evt){evt.preventDefault();var copyRow=$(this).prev('.duplicatedRow'),newRow=copyRow.clone(),inputs=newRow.find('input, select, textarea');if(inputs.length>0){inputs.each(function(){var inputName=$(this).attr('name').match(/(\w+)\[(\d+)\]\[(\w+)\]/);if(inputName===null){inputName=$(this).attr('name').match(/(\w+)\[(\d+)\]/);}
if(typeof(inputName[3])!='undefined'){var newName=inputName[1]+'['+(parseInt(inputName[2])+1)+']['+inputName[3]+']';}else{var newName=inputName[1]+'['+(parseInt(inputName[2])+1)+']';}
$(this).attr('name',newName).val('').removeAttr('selected');});if(newRow.find('a.removeRow').length==0){var deleteLink=$(document.createElement('a')).addClass('removeRow').html(deleteRowLabel);newRow.prepend(deleteLink);}}
newRow.insertAfter(copyRow).hide().slideDown('fast');});$('a.removeRow').live('click',function(evt){$(this).parents('.duplicatedRow').slideUp('fast',function(){$(this).remove();});});$('form#orderForm').submit(function(){recalculateTotal();updateOrder();return false});});